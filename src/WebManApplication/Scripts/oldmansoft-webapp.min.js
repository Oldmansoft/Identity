if(!window.oldmansoft){window.oldmansoft={}}window.oldmansoft.webapp=new (function(){var l=this,x={timeover:180000,loading_show_time:1000,loading_hide_time:200,server_charset:"utf-8"},t={ok:"Ok",yes:"Yes",no:"No",loading:"Loading",load_layout_error:"load layout error, click Ok to reload."},o=null,i=null,n=null,h=null,f=function(){return false},C=function(){return false},q=null,D=null,k=[],a=true,p,u=true,j=null,z=[],G=null,B,I,s,g=true,r=[],F,m=false;function A(N){if(!N){return""}if(N.indexOf("#")==0){return N.substr(1,N.length-1)}return N.replace(/\(/g,"(9)").replace(/\?/g,"(0)").replace(/\//g,"(1)").replace(/_/g,"(2)").replace(/#/g,"(3)").replace(/&/g,"(4)")}function v(N){if(!N){return""}return N.replace(/\(0\)/g,"?").replace(/\(1\)/g,"/").replace(/\(2\)/g,"_").replace(/\(3\)/g,"#").replace(/\(4\)/g,"&").replace(/\(9\)/g,"(")}function c(N){if(!N){return""}return N.replace(/\$7e/g,"~").replace(/\$23/g,"#").replace(/\$2f/g,"/").replace(/\$3f/g,"?").replace(/\$24/g,"$")}function e(P){var O=[],N,R;function Q(S){if(!S){return""}if(S.substr(0,1)=="#"){return S.substr(1)}return S}if(P instanceof Array){O=P.slice()}else{N=Q(P);if(N.indexOf("#")>-1||N.indexOf("%23")>-1){O=N.replace(/%23/g,"#").split("#")}else{if(N.indexOf("$")>-1){O=N.split("~");for(R=0;R<O.length;R++){O[R]=c(O[R])}}else{O=N.split("_");for(R=0;R<O.length;R++){O[R]=v(O[R])}}}}this.getLinks=function(){return O.slice()};this.push=function(S){return O.push(Q(S))};this.pop=function(){return O.pop()};this.last=function(){return O[O.length-1]};this.getContent=function(){var S=[],T;for(T=0;T<O.length;T++){S.push(A(O[T]))}return S.join("_")}}this.parser=function(N){return new e(N)};function y(Q,S,O){var P,N,R;if(Q==""){Q=O}P=Q.indexOf("&");if(P>-1){N=Q.indexOf("?");if(N==-1||P<N){Q=Q.substr(0,P)}}if(Q.substr(0,1)=="/"){return Q}if(!S){S=document.location.pathname}else{N=S.indexOf("?");if(N>-1){S=S.substr(0,N)}P=S.indexOf("&");if(P>-1){S=S.substr(0,P)}}R=S.split("/");R.pop();return R.join("/")+"/"+Q}function d(Q,O,N){for(var P=O;P>-1;P--){if(Q[P]==""&&N.substr(0,1)=="/"){return N}if(Q[P].substr(0,1)=="/"){return Q[P]}}return null}function J(O){var N,P;if(!O){return false}for(N=0;N<O.length;N++){P=O.substr(N,1);if(P==" "){continue}if(P=="\r"){continue}if(P=="\n"){continue}if(P=="\t"){continue}break}if(O.substr(N,15)=="<!DOCTYPE html>"){return true}if(O.substr(N,5)=="<html"){return true}return false}this.scriptLoader=new function(){var P=[];function O(S,R,Q){if(S.length==R+1){Q.resolve()}else{N(S,R+1,Q)}}function N(S,R,Q){if(P[S[R]]){O(S,R,Q);return}$.getScript(S[R],function(){P[S[R]]=true;O(S,R,Q)})}this.load=function(){var Q=$.Deferred();if(arguments.length==0){Q.resolve()}else{N(arguments,0,Q)}return Q}};this.bodyManagement=new function(){var N=0;this.expand=function(){if(N==0){$("body").addClass("layout-expanded");if(j){j.hide()}}N++};this.shrink=function(){N--;if(N==0){$("body").removeClass("layout-expanded");if(j){j.show()}}if(N<0){throw new Error("shrink error")}}};this.scrollbar=function(ah){if(!ah){return}var aa,ac,W,Z,R,P,ai,U,Y,T,ag=true;function O(aj,ak){if(aj.selector=="body"){if(ak!=undefined){$(document).scrollTop(ak)}else{return $(document).scrollTop()}}else{if(ak!=undefined){aj.scrollTop(ak)}else{return aj.scrollTop()}}}function N(al){var ak,aj;isSetTrackPosition=false;this.contentHeight=function(){return ak};this.viewHeight=function(){return aj};this.setHeight=function(){ak=al.scrollHeight;aj=window.innerHeight};this.setTrackPosition=function(am){if(isSetTrackPosition){return true}am.css("right",0);am.css("top",0);isSetTrackPosition=true;return true};this.bindMouseWheel=function(){$(window).on("mousewheel",X)};this.unbindMouseWheel=function(){$(window).off("mousewheel",X)}}function ad(am,al){var ak,aj;this.contentHeight=function(){return ak};this.viewHeight=function(){return aj};this.setHeight=function(){ak=al.scrollHeight;aj=am.innerHeight()};this.setTrackPosition=function(){return false};this.bindMouseWheel=function(){am.on("mousewheel",X)};this.unbindMouseWheel=function(){am.off("mousewheel",X)}}function af(){var aj=(ac.viewHeight()-ai)*O(ah)/(ac.contentHeight()-ac.viewHeight());P.css("top",aj)}function X(am){var al=am.target,an=am.originalEvent.wheelDelta,ak,aj;while(al!=am.currentTarget&&al!=null&&al.tagName!="HTML"&&al.tagName!="BODY"){aj=al.style.overflowY;if((aj=="auto"||aj=="scroll")&&al.clientHeight!=al.scrollHeight){if(an>0&&al.scrollTop>0){return true}if(an<0&&al.scrollTop+al.clientHeight<al.scrollHeight){return true}}al=al.parentElement}if(ac.contentHeight()<=ac.viewHeight()){return true}ak=O(ah);if(an<0){if(ak>=(ac.contentHeight()-ac.viewHeight())){return true}}else{if(ak==0){return true}}O(ah,ak-an);af();return false}function S(){return false}function V(aj){T=aj.clientY;Y=O(ah);U.on("selectstart",S);U.on("mousemove",Q);U.on("mouseup",ab);Z.addClass("focus")}function ab(){U.off("selectstart",S);U.off("mousemove",Q);U.off("mouseup",ab);Z.removeClass("focus")}function Q(ak){var aj=(ac.contentHeight()-ac.viewHeight())/(ac.viewHeight()-ai);O(ah,Y-(T-ak.clientY)*aj);af()}function ae(){ac.setHeight();if(ac.viewHeight()==0||ac.contentHeight()<=ac.viewHeight()){Z.hide();return}else{Z.show()}Z.height(ac.viewHeight());if(!ac.setTrackPosition(Z)){Z.css("left",ah.innerWidth()-parseInt(ah.css("padding-left"))-R);Z.css("top",-parseInt(ah.css("padding-top")))}ai=Z.height()*ac.viewHeight()/ac.contentHeight();if(ai<20){ai=20}P.height(ai);af()}ah=$(ah);aa=ah.get(0);ac=aa.tagName=="BODY"?new N(aa):new ad(ah,aa);U=$("html");ah.css("overflow","hidden");W=$("<div></div>").addClass("scrollbar-container");Z=$("<div></div>").addClass("scrollbar-track");P=$("<div></div>").addClass("scrollbar-arrow");W.append(Z);Z.append(P);ah.prepend(W);R=Z.width();ae();z.push(this);Z.mousedown(V);$(window).on("resize",ae);ac.bindMouseWheel();this.show=function(){if(ag){return}W.show();ac.bindMouseWheel();ag=true};this.hide=function(){if(!ag){return}ac.unbindMouseWheel();W.hide();ag=false};this.reset=function(){ae()}};this.resetScrollbar=function(){for(var N=0;N<z.length;N++){z[N].reset()}};this.resetWindowScrollbar=function(){if(j){j.reset();return}if(G==null){G="ontouchmove" in document}if(!G&&u){j=new l.scrollbar("body");setInterval(j.reset,500)}};function K(){function N(){var O=[];this.add=function(P){if(typeof(P)!="function"){throw new Error("fn is not a function")}O.push(P)};this.execute=function(P){for(var Q=0;Q<O.length;Q++){if(O[Q](P)===false){return false}}}}this.load=new N();this.unload=new N();this.active=new N();this.inactive=new N()}function L(O,N,P){this.node=O;this.name=N;this.level=P}function M(){var N=[];function O(Q,X,P,W){var V,T=true,S=0,U=0,R;this.link=X;this.node=$("<div></div>").addClass(Q+"-view").data("link",X);this.valid=false;V=new L(this.node,Q,P);this.hide=function(){if(!this.valid||!T){return}var Y=$(window);S=Y.scrollTop();U=Y.scrollLeft();if(R.inactive.execute(V)!==false){D.inactive.execute(V)}this.node.hide();T=false};this.callLoadAndActive=function(){if(R.load.execute(V)!==false){D.load.execute(V)}if(R.active.execute(V)!==false){D.active.execute(V)}};this.callInactiveAndUnload=function(){if(R.inactive.execute(V)!==false){D.inactive.execute(V)}if(R.unload.execute(V)!==false){D.unload.execute(V)}};this.remove=function(){if(this.valid&&R.inactive.execute(V)!==false){D.inactive.execute(V)}this.node.remove();if(!this.valid){return}if(R.unload.execute(V)!==false){D.unload.execute(V)}this.node=null;this.valid=false;R=null};this.show=function(){if(!this.valid||T){return}this.node.show();if(R.active.execute(V)!==false){D.active.execute(V)}$(window).scrollLeft(U);$(window).scrollTop(S);T=true};this.activeEvent=function(){if(!R){D.active.execute(V);return}if(R.active.execute(V)!==false){D.active.execute(V)}};this.inactiveEvent=function(){if(!R){D.inactive.execute(V);return}if(R.inactive.execute(V)!==false){D.inactive.execute(V)}};this.setContext=function(){q=new K();this.node.empty();if(arguments.length==1){this.node.html(arguments[0])}else{for(var Y=0;Y<arguments.length;Y++){this.node.append(arguments[Y])}}R=q;this.valid=true};this.getOption=function(){return W}}this.push=function(P,R,Q){N.push(new O(P,R,this.count()+1,Q))};this.pop=function(){return N.pop()};this.last=function(){return N[N.length-1]};this.like=function(P){if(N.length==0){return false}for(var Q=0;Q<N.length;Q++){if(P.length==Q){break}if(N[Q].link!=P[Q]){return false}}return true};this.count=function(){return N.length};this.get=function(P){return N[P]};this.replace=function(Q,P,T,S){var R=new O(P,T,Q+1,S);N[Q].node.after(R.node);N[Q].remove();N[Q]=R};this.getBackLink=function(){var P=new e(this.getLinks());P.pop();return P.getContent()};this.getLink=function(){var P=new e(this.getLinks());return P.getContent()};this.getLinks=function(){var P=[],Q;for(Q=0;Q<N.length;Q++){P.push(N[Q].link)}return P}}this.box=function(T,S){var Q=false,P,O,U=[],R=null;function V(X,W){if(X&&X.target!=X.currentTarget){return}P.stop(true);P.fadeOut(U.length>0?0:200,function(){l.bodyManagement.shrink();if(R==null){if(W){W()}return}if(R.close){R.close()}R.node.remove();if(U.length>0){R=U.pop();O.append(R.node);P.stop(true,true);P.fadeIn(0);if(W){W()}return}R=null;if(W){W()}})}function N(){if(Q){return}Q=true;P=$("<div></div>").addClass(T).addClass("box-background");if(S){O=$("<div></div>").addClass("layout-center-content");P.append($("<div></div>").addClass("layout-center").append(O))}else{O=P}P.prependTo($("body"));P.on("scroll",l.dealScrollToVisibleLoading)}this.open=function(W,X){N();if(R){if(R.node.data("type")=="message"){throw new Error("not allow show again after message show.")}U.push({node:R.node.detach(),close:R.close})}l.bodyManagement.expand();R={node:W,close:X};O.append(W);P.stop(true,true);P.fadeIn(200)};this.close=function(X,W){V(X,W)};this.clear=function(){if(!R){return}l.bodyManagement.shrink();if(R.close){R.close()}R.node.remove();while(U.length>0){R=U.pop();O.append(R.node);l.bodyManagement.shrink();if(R.close){R.close()}R.node.remove()}R=null;P.hide()}};h=new function(){var O,N=[];this.push=function(P){N.push(O);O=P};this.get=function(){return O};this.pop=function(){if(N.length==1){throw new Error("error call")}O=N.pop();return O}};B=new l.box("dialog-background",true);I=new l.box("window-background");s=new function(){var T=false,O,N=[],R=null;function S(V,U){if(V&&V.target!=V.currentTarget){return}R.node.stop(true);R.node.fadeOut(N.length>0?0:200,function(){l.bodyManagement.shrink();if(R==null){if(U){U()}return}if(R.close){R.close()}R.node.remove();if(N.length>0){R=N.pop();R.node.stop(true,true);R.node.fadeIn(0);if(U){U()}return}R=null;if(U){U()}})}function P(){if(T){return}T=true;O=$("<div></div>").addClass("modal-areas");O.prependTo($("body"))}function Q(W){var V,U;V=$("<div></div>").addClass("modal-background").addClass("box-background");U=$("<div></div>").addClass("layout-center-content");U.append(W);V.append($("<div></div>").addClass("layout-center").append(U));V.appendTo(O);V.on("click",function(X){if(X.currentTarget!=X.target&&X.currentTarget!=X.target.parentElement){return}if($(X.currentTarget).find(".force").length>0){return}n.close()});return V}this.open=function(U,V){P();if(R){N.push({node:R.node,close:R.close})}l.bodyManagement.expand();R={node:Q(U),close:V};R.node.stop(true,true);R.node.fadeIn(200)};this.close=function(V,U){S(V,U)};this.clear=function(){if(!R){return}l.bodyManagement.shrink();if(R.close){R.close()}R.node.remove();while(N.length>0){R=N.pop();l.bodyManagement.shrink();if(R.close){R.close()}R.node.remove()}R=null}};this.dialog=new function(){function N(){var O=$("<div></div>").addClass("dialog-box").addClass("box-panel");this.setHead=function(P){var Q=$("<div></div>").addClass("dialog-header");Q.append($("<h4></h4>").text(P));O.append(Q)};this.setBody=function(Q){var P=$("<div></div>").addClass("dialog-body");if(Q.indexOf("\n")>-1){$.each(Q.split("\n"),function(R,S){P.append($("<p></p>").text(S))})}else{P.text(Q)}O.append(P)};this.setFooter=function(){var Q=$("<div></div>").addClass("dialog-footer");function P(R){this.set=function(U,T){var V,S=$("<button></button>").text(U).addClass(T);S.click(function(W){B.close(W,function(){if(V){V()}})});R.append(S);return new function(){this.setCallback=function(W){V=W}}}}O.append(Q);return new P(Q)};this.get=function(P){O.data("type",P);return O};this.getElement=function(){return O}}this.alert=function(R,S,Q){var T,O=new N();function P(U){this.onConfirm=function(V){console.warn("onConfirm is obsolete. commend use ok");U.setCallback(V);return this};this.ok=function(V){U.setCallback(V);return this}}if(typeof S=="function"){Q=S;S=null}if(S){O.setHead(S)}O.setBody(R);T=O.setFooter().set(t.ok,"ok");if(Q){console.warn("fn is obsolete. commend use ok");T.setCallback(Q)}B.open(O.get("alert"));return new P(T)};this.confirm=function(T,V,U,Q){var O,P,W,S=new N();function R(Y,X){this.onConfirm=function(Z){console.warn("onConfirm is obsolete. commend use yes");Y.setCallback(Z);return this};this.yes=function(Z){Y.setCallback(Z);return this};this.onCancel=function(Z){console.warn("onCancel is obsolete. commend use no");X.setCallback(Z);return this};this.no=function(Z){X.setCallback(Z);return this}}if(typeof V=="function"){Q=U;U=V;V=null}if(V){S.setHead(V)}S.setBody(T);W=S.setFooter();O=W.set(t.yes,"yes");if(U){console.warn("fnYes is obsolete.");O.setCallback(U)}P=W.set(t.no,"no");if(Q){console.warn("fnNo is obsolete.");P.setCallback(Q)}B.open(S.get("confirm"));return new R(O,P)};this.message=function(P){var O=new N();O.setBody(P);B.open(O.get("message"));return new function(){this.close=function(Q){B.close(null,Q)};this.change=function(Q){O.getElement().find(".dialog-body").text(Q)}}}};this.loadingTip=new function(){var N;function O(){if(N!=null){return}N=$("<div></div>").addClass("loading-background").addClass("box-background");var P=$("<div></div>").addClass("loading-box").addClass("box-panel"),Q=$("<span></span>").text(t.loading);P.append(Q);N.append($("<div></div>").addClass("layout-center").append($("<div></div>").addClass("layout-center-content").append(P)));N.prependTo($("body"))}this.show=function(){O();l.bodyManagement.expand();N.stop(true,true);N.fadeIn(x.loading_show_time);return new function(){this.hide=function(){l.loadingTip.hide()}}};this.hide=function(){O();N.stop(true);N.fadeOut(x.loading_hide_time,function(){l.bodyManagement.shrink()})}};this.linker=new function(){var N=false,T=null,Q=null,U=null,S=null;function O(V){if(!V){return V}if(V.substr(0,1)=="#"){return V.substr(1)}return V}function R(){Q(T)}function P(){var V=new e(window.location.hash).getContent();if(T==V){return}T=V;R()}this.setChangeCompleted=function(V,W){U=V;S=W};this.callChangeCompleted=function(V){if(!U){return}if(S==null){U(V)}else{S.unshift(V);U.apply(null,S)}U=null;S=null};this.createHref=function(V){var X=new e(V).getContent(),W=document.location.origin+document.location.pathname;if(X==""){return W}return W+"#"+X};this.modify=function(V){window.location.hash=V;T=new e(V).getContent()};this.hash=function(V){if(V==undefined){return window.location.hash}window.location.hash=V;if(V==T){R()}return V};this.link=function(V){if(V==undefined){return h.get().getLink()}V=A(V);window.location.hash=V;if(V==T){R()}};this.add=function(V){var W=new e(window.location.hash);W.push(V);window.location.hash=W.getContent()};this.same=function(V){var W=new e(window.location.hash);W.pop();W.push(V);window.location.hash=W.getContent();if(W.getContent()==T){R()}};this.refresh=function(){R()};this._init=function(V){if(N){return}N=true;Q=V;T=O(window.location.hash);if("onhashchange" in window){window.onhashchange=P}else{window.setInterval(function(){if(T!=O(window.location.hash)){P()}},100)}R()}};function b(){var N=new M(),Q;function P(U,V,S,W,R){var T;if(N.count()>0){N.last().inactiveEvent()}else{h.get().inactiveCurrent();h.push(n)}N.push("modal",U,{closed:Q.closed,closedParameters:Q.closedParameters,data:V,type:S});T=N.last();T.node.addClass("box-panel");if(Q.force){T.node.addClass("force")}if(R==undefined){T.setContext(W)}else{T.setContext(W,R)}s.open(T.node,function(){T.remove()});T.callLoadAndActive();l.dealScrollToVisibleLoading()}function O(T,R){if(N.count()==0){return}var S=N.last();S.callInactiveAndUnload();if(R==undefined){S.setContext(T)}else{S.setContext(T,R)}S.callLoadAndActive();l.dealScrollToVisibleLoading()}this.load=function(T,U,S){var V=l.loadingTip.show(),R;R=y(T,d(N.getLinks(),N.count()-2,o.getDefaultLink()),o.getDefaultLink());$.ajax({mimeType:"text/html; charset="+x.server_charset,url:R,data:U,type:S,timeout:x.timeover}).done(function(Z,aa,Y){V.hide();var W=Y.getResponseHeader("X-Responded-JSON"),X;if(W){X=JSON.parse(W);if(X.status==401){if(!f(R,X.headers.location)){if(X.headers&&X.headers.location){document.location=X.headers.location}}return}}if(J(Z)){alert("You try to load wrong content: "+R);return}if(Q.refresh){O(Z)}else{P(T,U,S,Z)}if(Q.loaded){Q.loaded()}}).fail(function(Y,ac,Z){var ab,W,aa,X;V.hide();if(Y.status==401){f(R)}else{if(Y.status==0&&ac=="timeout"){ab=C();if(ab){if(Q.refresh){O(ab)}else{P(T,U,S,ab)}return}}}W=$(Y.responseText);aa=$("<h4></h4>").text(Z);X=$("<pre></pre>");if(W[11]!=null&&W[11].nodeType==8){X.text(W[11].data)}else{X.text(W.eq(1).text())}if(Q.refresh){O(aa,X)}else{P(T,U,S,aa,X)}});Q={closed:null,closedParameters:null,loaded:null,refresh:false,force:false};return Q};this.reload=function(){var S=N.last().getOption(),R=this.load(N.last().link,S.data,S.type);R.refresh=true};this.close=function(){var R=null,S=Array.from(arguments);s.close(null,function(){var T=N.pop().getOption(),U=N.last();if(U){U.activeEvent()}else{h.pop();h.get().activeCurrent()}if(T.closed){if(T.closedParameters!=null){if(S.length>0){T.closedParameters=T.closedParameters.concat(S)}T.closed.apply(null,T.closedParameters)}else{T.closed.apply(null,S)}}if(R){R(false)}});return new function(){this.completed=function(T){R=T}}};this.replace=function(S,T){var R=N.last();R.callInactiveAndUnload();R.link=S;R.setContext(T);R.callLoadAndActive()};this.clear=function(){s.clear();if(N.count()>0){N=new M();h.pop()}};this.getNode=function(){return N.last().node};this.getLink=function(){return N.last().link}}function w(){var N=new M(),Q;function P(U,V,S,W,R){var T;if(N.count()>0){N.last().hide()}else{h.get().inactiveCurrent();h.push(i)}N.push("open",U,{closed:Q.closed,closedParameters:Q.closedParameters,data:V,type:S});T=N.last();if(R==undefined){T.setContext(W)}else{T.setContext(W,R)}I.open(T.node,function(){T.remove()});T.callLoadAndActive();l.dealScrollToVisibleLoading()}function O(T,R){if(N.count()==0){return}var S=N.last();S.callInactiveAndUnload();if(R==undefined){S.setContext(T)}else{S.setContext(T,R)}S.callLoadAndActive();l.dealScrollToVisibleLoading()}this.load=function(T,U,S){var V=l.loadingTip.show(),R;n.clear();R=y(T,d(N.getLinks(),N.count()-2,o.getDefaultLink()),o.getDefaultLink());$.ajax({mimeType:"text/html; charset="+x.server_charset,url:R,data:U,type:S,timeout:x.timeover}).done(function(Z,aa,Y){V.hide();var W=Y.getResponseHeader("X-Responded-JSON"),X;if(W){X=JSON.parse(W);if(X.status==401){if(!f(R,X.headers.location)){if(X.headers&&X.headers.location){document.location=X.headers.location}}return}}if(J(Z)){alert("You try to load wrong content: "+R);return}if(Q.refresh){O(Z)}else{P(T,U,S,Z)}if(Q.loaded){Q.loaded()}}).fail(function(Y,ac,Z){var ab,W,aa,X;V.hide();if(Y.status==401){f(R)}else{if(Y.status==0&&ac=="timeout"){ab=C();if(ab){if(Q.refresh){O(ab)}else{P(T,U,S,ab)}return}}}W=$(Y.responseText);aa=$("<h4></h4>").text(Z);X=$("<pre></pre>");if(W[11]!=null&&W[11].nodeType==8){X.text(W[11].data)}else{X.text(W.eq(1).text())}if(Q.refresh){O(aa,X)}else{P(T,U,S,aa,X)}});Q={closed:null,closedParameters:null,loaded:null,refresh:false};return Q};this.reload=function(){var S=N.last().getOption(),R=this.load(N.last().link,S.data,S.type);R.refresh=true};this.close=function(){var R=null,S=Array.from(arguments);I.close(null,function(){var T=N.pop().getOption(),U=N.last();if(U){U.show()}else{h.pop();o.activeCurrent()}if(T.closed){if(T.closedParameters!=null){if(S.length>0){T.closedParameters=T.closedParameters.concat(S)}T.closed.apply(null,T.closedParameters)}else{T.closed.apply(null,S)}}if(R){R(false)}});return new function(){this.completed=function(T){R=T}}};this.replace=function(S,T){var R=N.last();R.callInactiveAndUnload();R.link=S;R.setContext(T);R.callLoadAndActive()};this.clear=function(){I.clear();if(N.count()>0){N=new M();h.pop()}};this.activeCurrent=function(){N.last().activeEvent()};this.inactiveCurrent=function(){N.last().inactiveEvent()};this.getNode=function(){return N.last().node};this.getLink=function(){return N.last().link}}function E(U,T){var O=0,Q=null,R=T,V=new M(),N=true;function P(Y,W){var X;X=V.last();if(W==undefined){X.setContext(Y)}else{X.setContext(Y,W)}X.callLoadAndActive();l.resetWindowScrollbar();$(window).scrollTop(0);l.dealScrollToVisibleLoading()}function S(Y,aa,ab,Z){var W=++O,ac=null,X=y(Y,aa,R);if(m){m=false}else{ac=l.loadingTip.show()}$.ajax({mimeType:"text/html; charset="+x.server_charset,url:X,type:"GET",timeout:x.timeover}).done(function(ag,ah,af){if(W!=O){return}if(ac){ac.hide()}var ad=af.getResponseHeader("X-Responded-JSON"),ae;if(ad){ae=JSON.parse(ad);if(ae.status==401){if(!f(X,ae.headers.location)){if(ae.headers&&ae.headers.location){document.location=ae.headers.location}}return}}if(J(ag)){alert("You try to load wrong content: "+X);return}ab();P(ag);if(Z){Z(true)}}).fail(function(af,aj,ag){var ai,ad,ah,ae;if(W!=O){return}if(ac){ac.hide()}if(af.status==401){f(X)}else{if(af.status==0&&aj=="timeout"){ai=C();if(ai){ab();P(ai);return}}}ad=$(af.responseText);ah=$("<h4></h4>").text(ag);ae=$("<pre></pre>");if(ad[11]!=null&&ad[11].nodeType==8){ae.text(ad[11].data)}else{ae.text(ad.eq(1).text())}ab();P(ah,ae)})}this.load=function(X,Y){var Z,W;if(Q==null){Q=$(U)}if(Q.is("body")){throw new Error("viewNode can't be <body>")}Z=new e(X).getLinks();n.clear();i.clear();B.clear();if(V.count()>Z.length&&V.like(Z)&&V.get(Z.length-1).valid){for(W=V.count()-1;W>Z.length-1;W--){V.pop().remove()}V.last().show();l.resetWindowScrollbar();if(Y){Y(false)}return}S(Z[Z.length-1],d(Z,Z.length-2,R),function(){var ab,aa;if(N){Q.empty();N=false}if(V.count()>Z.length&&V.like(Z)){for(ab=V.count()-1;ab>Z.length-1;ab--){V.pop().remove()}}else{aa=V.count();for(ab=aa-1;ab>Z.length-1;ab--){V.pop().remove()}for(ab=0;ab<Z.length;ab++){if(aa>ab){if(V.get(ab).link!=Z[ab]||(aa==ab+1&&Z.length==aa)){V.replace(ab,"main",Z[ab],{baseLink:d(Z,ab-1,R)})}else{V.get(ab).hide()}}else{V.push("main",Z[ab],{baseLink:d(Z,ab-1,R)});Q.append(V.last().node)}}}},Y)};this.reload=function(){S(V.last().link,V.last().getOption().baseLink,function(){V.last().callInactiveAndUnload()})};this.close=function(){var W=null,X=Array.from(arguments);if(V.count()>1){if(V.get(V.count()-2).valid){V.pop().remove();l.linker.modify(V.getLink());V.last().show();l.resetWindowScrollbar();setTimeout(function(){X.unshift(false);if(W){W.apply(null,X)}},1)}else{setTimeout(function(){l.linker.setChangeCompleted(W,X);l.linker.hash(V.getBackLink())},1)}}return new function(){this.completed=function(Y){W=Y}}};this.replace=function(X,Y){var W=V.last();W.callInactiveAndUnload();W.link=X;W.setContext(Y);W.callLoadAndActive()};this.getElement=function(){return Q};this.setElement=function(W){return Q=$(W)};this.getDefaultLink=function(){return R};this.setDefaultLink=function(W){R=W};this.activeCurrent=function(){V.last().activeEvent()};this.inactiveCurrent=function(){V.last().inactiveEvent()};this.getLinks=function(){return V.getLinks()};this.getNode=function(){return V.last().node};this.getLink=function(){return V.last().link}}this.current=function(){return{node:h.get().getNode(),link:h.get().getLink(),view:h.get()}};this.event=function(){return new function(){this.onLoad=function(N){q.load.add(N);return this};this.onUnload=function(N){q.unload.add(N);return this};this.onActive=function(N){q.active.add(N);return this};this.onInactive=function(N){q.inactive.add(N);return this}}};this.viewClose=function(N){return h.get().close(N)};this.viewReload=function(){h.get().reload()};this.dealScrollToVisibleLoading=function(N){var P,O;if(N&&typeof(N.find)=="function"){P=N.find(".webapp-loading:visible").first()}else{P=$(".webapp-loading:visible").first()}if(P.length>0&&!P.data("work")&&$(window).scrollTop()+$(window).height()>P.offset().top){P.data("work",true);O=P.attr("data-src");if(!O){return}$.get(O,function(R){P.before(R);P.remove();for(var Q=0;Q<k.length;Q++){if(k[Q]()===false){return false}}l.resetWindowScrollbar();l.dealScrollToVisibleLoading(N)})}};function H(Q){var P,O,N=true;if($("body").hasClass("layout-expanded")){P=Q.originalEvent.path;if(!P){return}for(O=0;O<P.length;O++){if(P[O].tagName=="BODY"){break}if(P[O].scrollHeight>P[O].clientHeight){N=false;break}}if(N){Q.preventDefault()}}}p={_base:function(N){l.linker.link(N)},_link:function(N){l.linker.link(N)},_add:function(N){l.linker.add(N)},_same:function(N){l.linker.same(N)},_open:function(N,O){l.open(N,O.attr("data-data"))},_modal:function(N,O){l.modal(N,O.attr("data-data"))}};this.configTarget=function(N){if(typeof N=="function"){N(p)}};this.hashes=function(){return o.getLinks()};this.open=function(N,P){var O;if(P){O=i.load(N,P,"POST")}else{O=i.load(N,P,"GET")}return new function(){this.closed=function(R){O.closed=R;if(arguments.length>1){O.closedParameters=[];for(var Q=1;Q<arguments.length;Q++){O.closedParameters.push(arguments[Q])}}};this.loaded=function(Q){O.loaded=Q}}};this.modal=function(N,P){var O;if(P){O=n.load(N,P,"POST")}else{O=n.load(N,P,"GET")}return new function(){this.closed=function(R){O.closed=R;if(arguments.length>1){O.closedParameters=[];for(var Q=1;Q<arguments.length;Q++){O.closedParameters.push(arguments[Q])}}};this.loaded=function(Q){O.loaded=Q};this.force=function(Q){O.force=Q}}};this.find=function(N){return l.current().node.find(N)};this.configSetting=function(N){if(typeof N=="function"){N(x)}};this.configText=function(N){if(typeof N=="function"){N(t)}};this.option=function(){return F};this.initialled=function(N){if(typeof N!="function"){return}r.push(N)};this.initialization=function(O,N){function Q(R){this.viewNode=function(S){if(!S){return R.getElement()}R.setElement(S);return this};this.defaultLink=function(S){if(!S){return R.getDefaultLink()}R.setDefaultLink(S);return this};this.unauthorized=function(S){f=S;return this};this.loadTimeout=function(S){C=S;return this};this.dealLinkEmptyTarget=function(S){if(S==undefined){return a}a=S;return this};this.replacePCScrollBar=function(S){u=S;return this};this.viewLoaded=function(S){D.load.add(S);return this};this.viewActived=function(S){D.active.add(S);return this};this.viewInactived=function(S){D.inactive.add(S);return this};this.viewUnloaded=function(S){D.unload.add(S);return this};this.visibleLoadingCompleted=function(S){if(typeof(S)!="function"){throw new Error("fn is not a function")}k.push(S);return this}}if(!!window.ActiveXObject||"ActiveXObject" in window){$.ajaxSetup({cache:false})}$(document).on("click","a",function(T){var S=$(this).attr("target"),R=$(this).attr("href");if(R=="#"){T.preventDefault();return}if(!S){if(!a){return}T.preventDefault();p._link(R);return}if(S=="_none"){return}if(p[S]){T.preventDefault();p[S](R,$(this))}});$(document).on("click",".webapp-close",function(R){R.preventDefault();l.viewClose($(this).attr("data-close"))});$(window).on("scroll",l.dealScrollToVisibleLoading);$(window).on("resize",l.dealScrollToVisibleLoading);$(document).on("touchmove",H);D=new K();o=new E(O,N);i=new w();n=new b();h.push(o);F=new Q(o);for(var P in r){r[P]()}return F};this.init=function(Q,O,P){var N=l.initialization(Q,O);if(P){m=true}l.linker._init(function(R){o.load(R,l.linker.callChangeCompleted)});return N};this.setup=function(Q,O,P){if(g){g=false}else{throw new Error("Has been setup")}var N=l.initialization(Q,O);$(function(){if(P){m=true}l.linker._init(function(R){o.load(R,l.linker.callChangeCompleted)})});return N};this.setupLayout=function(P,R,Q,O){if(g){g=false}else{throw new Error("Has been setup")}var N=l.initialization(Q,O);$(function(){$.ajax({mimeType:"text/html; charset="+x.server_charset,url:R,type:"GET",timeout:x.timeover}).done(function(V,W,U){var S=U.getResponseHeader("X-Responded-JSON"),T;if(S){T=JSON.parse(S);if(T.status==401){if(!f(R,T.headers.location)){if(T.headers&&T.headers.location){document.location=T.headers.location}}return}}if(J(V)){alert("You try to load wrong content: "+R);return}$(P).html(V).children().unwrap();m=true;l.linker._init(function(X){o.load(X,l.linker.callChangeCompleted)})}).fail(function(S,V,T){var U;if(S.status==401){f(R)}else{if(S.status==0&&V=="timeout"){U=C();if(U){$(P).html(U).children().unwrap();return}}}l.dialog.alert(t.load_layout_error,T).ok(function(){document.location.reload()})})});return N};window.$app={configSetting:l.configSetting,configText:l.configText,alert:l.dialog.alert,confirm:l.dialog.confirm,message:l.dialog.message,loading:l.loadingTip.show,loadScript:l.scriptLoader.load,href:l.linker.createHref,hash:l.linker.hash,link:l.linker.link,add:l.linker.add,same:l.linker.same,open:l.open,modal:l.modal,event:l.event,reload:l.viewReload,close:l.viewClose,current:l.current,find:l.find,option:l.option,init:l.init,setup:l.setup,setupLayout:l.setupLayout}})();