if(!window.oldmansoft){window.oldmansoft={}}window.oldmansoft.webapp=new (function(){var f=this,m={timeover:180000,loading_show_time:1000,loading_hide_time:200},v="ActiveXObject" in window,b={ok:"Ok",yes:"Yes",no:"No",loading:"Loading"},t=null,w=null,g=null,a=function(){return false},u=null,x=true,e=true,i=null,h=[],y=null,p=null,q,c,o;function s(E,G,C){var D,B,F;if(E==""){E=C}D=E.indexOf("&");if(D>-1){B=E.indexOf("?");if(B==-1||D<B){E=E.substr(0,D)}}if(E.substr(0,1)=="/"){return E}if(!G){G=document.location.pathname}else{B=G.indexOf("?");if(B>-1){G=G.substr(0,B)}D=G.indexOf("&");if(D>-1){G=G.substr(0,D)}}F=G.split("/");F.pop();return F.join("/")+"/"+E}function d(E,C,B){for(var D=C;D>-1;D--){if(E[D]==""&&B.substr(0,1)=="/"){return B}if(E[D].substr(0,1)=="/"){return E[D]}}return null}function l(C){var B,D;if(!C){return false}for(B=0;B<C.length;B++){D=C.substr(B,1);if(D==" "){continue}if(D=="\r"){continue}if(D=="\n"){continue}if(D=="\t"){continue}break}if(C.substr(B,15)=="<!DOCTYPE html>"){return true}if(C.substr(B,5)=="<html"){return true}return false}this.scriptLoader=new function(){var D=[];function C(G,F,E){if(G.length==F+1){E.resolve()}else{B(G,F+1,E)}}function B(G,F,E){if(D[G[F]]){C(G,F,E);return}$.getScript(G[F],function(){D[G[F]]=true;C(G,F,E)})}this.load=function(){var E=$.Deferred();if(arguments.length==0){E.resolve()}else{B(arguments,0,E)}return E}};this.bodyManagement=new function(){var B=0;this.expand=function(){if(B==0){$("body").addClass("layout-expanded");if(i){i.hide()}}B++};this.shrink=function(){B--;if(B==0){$("body").removeClass("layout-expanded");if(i){i.show()}}if(B<0){throw"shrink error"}}};this.scrollbar=function(V){if(!V){return}var O,Q,K,N,F,D,W,I,M,H,U=true;function C(X,Y){if(X.selector=="body"&&v){if(Y!=undefined){$(document).scrollTop(Y)}else{return $(document).scrollTop()}}else{if(Y!=undefined){X.scrollTop(Y)}else{return X.scrollTop()}}}function B(Z){var Y,X;isSetTrackPosition=false;this.contentHeight=function(){return Y};this.viewHeight=function(){return X};this.setHeight=function(){Y=Z.scrollHeight;X=window.innerHeight};this.setTrackPosition=function(aa){if(isSetTrackPosition){return true}aa.css("right",0);aa.css("top",0);isSetTrackPosition=true;return true};this.bindMouseWheel=function(){$(window).on("mousewheel",L)};this.unbindMouseWheel=function(){$(window).off("mousewheel",L)}}function R(aa,Z){var Y,X;this.contentHeight=function(){return Y};this.viewHeight=function(){return X};this.setHeight=function(){Y=Z.scrollHeight;X=aa.innerHeight()};this.setTrackPosition=function(){return false};this.bindMouseWheel=function(){aa.on("mousewheel",L)};this.unbindMouseWheel=function(){aa.off("mousewheel",L)}}function T(){var X=(Q.viewHeight()-W)*C(V)/(Q.contentHeight()-Q.viewHeight());D.css("top",X)}function L(Y){if(Q.contentHeight()<=Q.viewHeight()){return true}var Z=Y.originalEvent.wheelDelta,X=C(V);if(Z<0){if(X>=(Q.contentHeight()-Q.viewHeight())){return true}}else{if(X==0){return true}}C(V,X-Z);T();return false}function G(){return false}function J(X){H=X.clientY;M=C(V);I.on("selectstart",G);I.on("mousemove",E);I.on("mouseup",P);N.addClass("focus")}function P(){I.off("selectstart",G);I.off("mousemove",E);I.off("mouseup",P);N.removeClass("focus")}function E(Y){var X=(Q.contentHeight()-Q.viewHeight())/(Q.viewHeight()-W);C(V,M-(H-Y.clientY)*X);T()}function S(){Q.setHeight();if(Q.viewHeight()==0||Q.contentHeight()<=Q.viewHeight()){N.hide();return}else{N.show()}N.height(Q.viewHeight());if(!Q.setTrackPosition(N)){N.css("left",V.innerWidth()-parseInt(V.css("padding-left"))-F);N.css("top",-parseInt(V.css("padding-top")))}W=N.height()*Q.viewHeight()/Q.contentHeight();if(W<20){W=20}D.height(W);T()}V=$(V);O=V.get(0);Q=O.tagName=="BODY"?new B(O):new R(V,O);I=$("html");V.css("overflow","hidden");K=$("<div></div>").addClass("scrollbar-container");N=$("<div></div>").addClass("scrollbar-track");D=$("<div></div>").addClass("scrollbar-arrow");K.append(N);N.append(D);V.prepend(K);F=N.width();S();h.push(this);N.mousedown(J);$(window).on("resize",S);Q.bindMouseWheel();this.show=function(){if(U){return}K.show();Q.bindMouseWheel();U=true};this.hide=function(){if(!U){return}Q.unbindMouseWheel();K.hide();U=false};this.reset=function(){S()}};this.resetScrollbar=function(){for(var B=0;B<h.length;B++){h[B].reset()}};this.resetWindowScrollbar=function(){if(i){i.reset();return}if(y==null){y="ontouchmove" in document}if(!y&&e){i=new f.scrollbar("body");setInterval(i.reset,500)}};function r(){this.load=function(){};this.unload=function(){};this.active=function(){};this.inactive=function(){}}function A(C,B,D){this.node=C;this.name=B;this.level=D}function n(){var B=[];function C(E,L,D){var K,H=true,F=0,I=0,G,J={closed:null};this.link=L;this.node=$("<div></div>").addClass(E+"-view").data("link",L);this.valid=false;K=new A(this.node,E,D);this.hide=function(){if(!this.valid||!H){return}var M=$(window);F=M.scrollTop();I=M.scrollLeft();p.inactive(K,G.inactive(K));this.node.hide();H=false};this.callLoadAndActive=function(){p.load(K,G.load(K));p.active(K,G.active(K))};this.callInactiveAndUnload=function(){p.inactive(K,G.inactive(K));p.unload(K,G.unload(K))};this.remove=function(){this.node.remove();if(!this.valid){return}this.callInactiveAndUnload();this.node=null;this.valid=false;G=null};this.show=function(){if(!this.valid||H){return}this.node.show();p.active(K,G.active(K));$(window).scrollLeft(I);$(window).scrollTop(F);H=true};this.activeEvent=function(){if(!G){return}p.active(K,G.active(K))};this.inactiveEvent=function(){if(!G){return}p.inactive(K,G.inactive(K))};this.setContext=function(){u=new r();if(arguments.length==1){this.node.html(arguments[0])}else{this.node.empty();for(var M=0;M<arguments.length;M++){this.node.append(arguments[M])}}G=u;this.valid=true};this.getOption=function(){return J}}this.push=function(D,E){B.push(new C(D,E,this.count()+1))};this.pop=function(){return B.pop()};this.last=function(){return B[B.length-1]};this.like=function(D){if(B.length==0){return false}for(var E=0;E<B.length;E++){if(D.length==E){break}if(B[E].link!=D[E]){return false}}return true};this.count=function(){return B.length};this.get=function(D){return B[D]};this.replace=function(E,D,G){var F=new C(D,G,E+1);B[E].node.after(F.node);B[E].remove();B[E]=F};this.getBackLink=function(){var D=this.getLinks().slice();D.splice(0,0,"");D.splice(D.length-1,1);return D.join("#")};this.getLink=function(){var D=this.getLinks().slice();D.splice(0,0,"");return D.join("#")};this.getLinks=function(){var D=[],E;for(E=0;E<B.length;E++){D.push(B[E].link)}return D}}this.box=function(H,G){var E=false,D,C,I=[],F=null;function J(L,K){if(L&&L.target!=L.currentTarget){return}D.stop(true);D.fadeOut(I.length>0?0:200,function(){f.bodyManagement.shrink();if(F==null){if(K){K()}return}if(F.close){F.close()}F.node.remove();if(I.length>0){F=I.pop();C.append(F.node);if(K){K()}D.stop(true,true);D.fadeIn(0);return}F=null;if(K){K()}})}function B(){if(E){return}E=true;D=$("<div></div>").addClass(H).addClass("box-background");if(G){C=$("<div></div>").addClass("layout-horizontal");D.append(C);D.append($("<div></div>").addClass("layout-vertical"))}else{C=D}D.prependTo($("body"))}this.open=function(K,L){B();if(F){if(F.node.data("type")=="message"){throw"not allow show again after message show."}I.push({node:F.node.detach(),close:F.close})}f.bodyManagement.expand();F={node:K,close:L};C.append(K);D.stop(true,true);D.fadeIn(200)};this.close=function(L,K){J(L,K)};this.clear=function(){if(!F){return}if(F.close){F.close()}F.node.remove();while(I.length>0){F=I.pop();C.append(F.node);if(F.close){F.close()}F.node.remove()}F=null;D.hide()}};c=new f.box("dialog-background",true);o=new f.box("window-background");this.dialog=new function(){function B(){var C=$("<div></div>").addClass("dialog-box").addClass("box-panel");this.setHead=function(D){var E=$("<div></div>").addClass("dialog-header");E.append($("<h4></h4>").text(D));C.append(E)};this.setBody=function(E){var D=$("<div></div>").addClass("dialog-body").text(E);C.append(D)};this.setFooter=function(){var E=$("<div></div>").addClass("dialog-footer");function D(F){this.set=function(H){var I,G=$("<button></button>").text(H);G.click(function(J){c.close(J,function(){if(I){I()}})});F.append(G);return new function(){this.setCallback=function(J){I=J}}}}C.append(E);return new D(E)};this.get=function(D){C.data("type",D);return C};this.getElement=function(){return C}}this.alert=function(F,G,E){var H,C=new B();function D(I){this.onConfirm=function(J){console.warn("onConfirm is obsolete. commend use ok");I.setCallback(J);return this};this.ok=function(J){I.setCallback(J);return this}}if(typeof G=="function"){E=G;G=null}if(G){C.setHead(G)}C.setBody(F);H=C.setFooter().set(b.ok);if(E){console.warn("fn is obsolete. commend use ok");H.setCallback(E)}c.open(C.get("alert"));return new D(H)};this.confirm=function(H,J,I,E){var C,D,K,G=new B();function F(M,L){this.onConfirm=function(N){console.warn("onConfirm is obsolete. commend use yes");M.setCallback(N);return this};this.yes=function(N){M.setCallback(N);return this};this.onCancel=function(N){console.warn("onCancel is obsolete. commend use no");L.setCallback(N);return this};this.no=function(N){L.setCallback(N);return this}}if(typeof J=="function"){E=I;I=J;J=null}if(J){G.setHead(J)}G.setBody(H);K=G.setFooter();C=K.set(b.yes,I);if(I){console.warn("fnYes is obsolete.");C.setCallback(I)}D=K.set(b.no,E);if(E){console.warn("fnNo is obsolete.");D.setCallback(E)}c.open(G.get("confirm"));return new F(C,D)};this.message=function(D){var C=new B();C.setBody(D);c.open(C.get("message"));return new function(){this.close=function(E){c.close(null,E)};this.change=function(E){C.getElement().find(".dialog-body").text(E)}}}};this.loadingTip=new function(){var B;function C(){if(B!=null){return}B=$("<div></div>").addClass("loading-background").addClass("box-background");var D=$("<div></div>").addClass("loading-box").addClass("box-panel"),E=$("<span></span>").text(b.loading);D.append(E);B.append($("<div></div>").addClass("layout-horizontal").append(D)).append($("<div></div>").addClass("layout-vertical"));B.prependTo($("body"))}this.show=function(){C();f.bodyManagement.expand();B.stop(true,true);B.fadeIn(m.loading_show_time);return new function(){this.hide=function(){f.loadingTip.hide()}}};this.hide=function(){C();B.stop(true);B.fadeOut(m.loading_hide_time,function(){f.bodyManagement.shrink()})}};this.linker=new function(){var B=false,H=null,E=null,G=false,I=null;function C(J){if(!J){return J}if(J.substr(0,1)=="#"){return J.substr(1)}return J}function F(){E(H)}function D(){var J=C(window.location.hash);if(H==J){return}H=J;if(G){G=false;return}F()}this.setChangeCompleted=function(J){I=J};this.callChangeCompleted=function(J){if(!I){return}I(J);I=null};this.modify=function(J){G=true;window.location.hash=J};this.hash=function(J){if(J==undefined){return window.location.hash}window.location.hash=J;if(J==H){F()}return J};this.addHash=function(J){J=C(J);if(window.location.hash==""){window.location.hash="##"+J}else{window.location.hash+="#"+J}};this.sameHash=function(J){J=C(J);var K=window.location.hash.split("#");if(K.length==1){K=["",""]}K.pop();K.push(J);window.location.hash=K.join("#");if(J==H){F()}};this.refresh=function(){F()};this._init=function(J){if(B){return}B=true;E=J;H=C(window.location.hash);if("onhashchange" in window){window.onhashchange=D}else{window.setInterval(function(){if(H!=C(window.location.hash)){D()}},100)}F()}};function z(){var B=new n(),D={closed:null};function C(G,H,E){var F;if(B.count()>0){B.last().hide()}else{t.inactiveCurrent();g=w}B.push("open",G);F=B.last();if(E==undefined){F.setContext(H)}else{F.setContext(H,E)}o.open(F.node,function(){F.remove()});F.callLoadAndActive();F.getOption().closed=D.closed}this.load=function(G,H,F,I){var J=f.loadingTip.show(),E;E=s(G,d(B.getLinks(),B.count()-2,t.getDefaultLink()),t.getDefaultLink());$.ajax({mimeType:"text/html; charset=utf-8",url:E,data:H,type:F,timeout:m.timeover}).done(function(N,O,M){J.hide();var K=M.getResponseHeader("X-Responded-JSON"),L;if(K){L=JSON.parse(K);if(L.status==401){if(!a(L.headers.location)){if(L.headers&&L.headers.location){document.location=L.headers.location;return}}}}if(l(N)){alert("You try to load wrong content: "+E);return}C(G,N);if(I){I(true)}}).fail(function(M,P,N){J.hide();if(M.status==401){a(G)}var K=$(M.responseText),O=$("<h4></h4>").text(N),L=$("<pre></pre>");if(K[11]!=null&&K[11].nodeType==8){L.text(K[11].data)}else{L.text(K.eq(1).text())}C(G,O,L);if(I){I(true)}});D.closed=null;return D};this.close=function(G,E){var F=B.pop().getOption().closed;o.close(null,function(){var H=B.last();if(H){H.show()}else{g=t;t.activeCurrent()}if(F){F(G)}if(E){E(false)}})};this.replace=function(F,G){var E=B.last();E.callInactiveAndUnload();E.link=F;E.setContext(G);E.callLoadAndActive()};this.clear=function(){o.clear();if(B.count()>0){B=new n()}};this.getNode=function(){return B.last().node}}function k(C,H){var E=0,F=$(C),B=H,D=new n();function G(L,M,J){var K;K=D.last();if(J==undefined){K.setContext(M)}else{K.setContext(M,J)}K.callLoadAndActive();f.resetWindowScrollbar();$(window).scrollTop(0);f.dealScrollToVisibleLoading()}function I(L,P,N,M){var J=++E,O,K;O=f.loadingTip.show();K=s(L,P,B);$.ajax({mimeType:"text/html; charset=utf-8",url:K,type:"GET",timeout:m.timeover}).done(function(T,U,S){if(J!=E){return}O.hide();var Q=S.getResponseHeader("X-Responded-JSON"),R;if(Q){R=JSON.parse(Q);if(R.status==401){if(!a(R.headers.location)){if(R.headers&&R.headers.location){document.location=R.headers.location;return}}}}if(l(T)){alert("You try to load wrong content: "+K);return}N();G(L,T);if(M){M(true)}}).fail(function(S,V,T){if(J!=E){return}O.hide();if(S.status==401){a(L)}var Q=$(S.responseText),U=$("<h4></h4>").text(T),R=$("<pre></pre>");if(Q[11]!=null&&Q[11].nodeType==8){R.text(Q[11].data)}else{R.text(Q.eq(1).text())}N();G(L,U,R);if(M){M(true)}})}this.load=function(K,L){var M,J;K=K.replace(/%23/g,"#");M=K.split("#");w.clear();c.clear();if(D.count()>M.length&&D.like(M)&&D.get(M.length-1).valid){for(J=D.count()-1;J>M.length-1;J--){D.pop().remove()}D.last().show();f.resetWindowScrollbar();if(L){L(false)}return}I(M[M.length-1],d(M,M.length-2,B),function(){var O,N;if(D.count()>M.length&&D.like(M)){for(O=D.count()-1;O>M.length-1;O--){D.pop().remove()}}else{N=D.count();for(O=N-1;O>M.length-1;O--){D.pop().remove()}for(O=0;O<M.length;O++){if(N>O){if(D.get(O).link!=M[O]||(N==O+1&&M.length==N)){D.replace(O,"main",M[O])}else{D.get(O).hide()}}else{D.push("main",M[O]);F.append(D.last().node)}}}},L)};this.close=function(K,J){if(D.count()>1){if(D.get(D.count()-2).valid){D.pop().remove();D.last().show();f.resetWindowScrollbar();f.linker.modify(D.getLink());if(J){J(false)}}else{f.linker.setChangeCompleted(J);f.linker.hash(D.getBackLink())}}};this.replace=function(K,L){var J=D.last();J.callInactiveAndUnload();J.link=K;J.setContext(L);J.callLoadAndActive()};this.getElement=function(){return F};this.setElement=function(J){return F=$(J)};this.getDefaultLink=function(){return B};this.setDefaultLink=function(J){B=J};this.activeCurrent=function(){D.last().activeEvent()};this.inactiveCurrent=function(){D.last().inactiveEvent()};this.getLinks=function(){return D.getLinks()};this.getNode=function(){return D.last().node}}this.current=function(){return{node:g.getNode(),view:g}};this.event=function(){return new function(){this.onLoad=function(B){u.load=B;return this};this.onUnload=function(B){u.unload=B;return this};this.onActive=function(B){u.active=B;return this};this.onInactive=function(B){u.inactive=B;return this}}};this.viewClose=function(C,B){g.close(C,B)};this.dealScrollToVisibleLoading=function(){var C=$(".webapp-loading:visible"),B;if(C.length>0&&!C.data("work")&&$(window).scrollTop()+$(window).height()>C.offset().top){C.data("work",true);B=C.attr("data-src");if(!B){return}$.get(B,function(D){C.before(D);C.remove();f.resetWindowScrollbar();f.dealScrollToVisibleLoading()})}};function j(E){var D,C,B=true;if($("body").hasClass("layout-expanded")){D=E.originalEvent.path;for(C=0;C<D.length;C++){if(D[C].tagName=="BODY"){break}if(D[C].scrollHeight>D[C].clientHeight){B=false;break}}if(B){E.preventDefault()}}}q={_base:function(B){f.linker.hash(B)},_add:function(B){f.linker.addHash(B)},_same:function(B){f.linker.sameHash(B)},_open:function(B,C){f.open(B,C.attr("data-data"))}};this.configTarget=function(B){if(typeof B=="function"){B(q)}};this.hashes=function(){return t.getLinks()};this.open=function(B,D){var C;if(D){C=w.load(B,D,"POST")}else{C=w.load(B,D,"GET")}return new function(){this.closed=function(E){C.closed=E}}};this.configSetting=function(B){if(typeof B=="function"){B(m)}};this.configText=function(B){if(typeof B=="function"){B(b)}};this.init=function(C,B){function D(E){this.viewNode=function(F){if(!F){return E.getElement()}E.setElement(F);return this};this.defaultLink=function(F){if(!F){return E.getDefaultLink()}E.setDefaultLink(F);return this};this.unauthorized=function(F){a=F;return this};this.dealLinkEmptyTarget=function(F){if(F==undefined){return x}x=F;return this};this.replacePCScrollBar=function(F){e=F;return this};this.viewLoaded=function(F){p.load=F;return this};this.viewActived=function(F){p.active=F;return this};this.viewInactived=function(F){p.inactive=F;return this};this.viewUnloaded=function(F){p.unload=F;return this}}if(!!window.ActiveXObject||"ActiveXObject" in window){$.ajaxSetup({cache:false})}$(document).on("click","a",function(G){var F=$(this).attr("target"),E=$(this).attr("href");if(E=="#"){G.preventDefault();return}if(!F){if(!x){return}G.preventDefault();q._base(E);return}if(F=="_none"){return}if(q[F]){G.preventDefault();q[F](E,$(this))}});$(document).on("click",".webapp-close",function(E){E.preventDefault();f.viewClose($(this).attr("data-close"))});$(window).on("scroll",f.dealScrollToVisibleLoading);$(window).on("resize",f.dealScrollToVisibleLoading);$(document).on("touchmove",j);p=new r();t=new k(C,B);w=new z();g=t;f.linker._init(function(E){t.load(E,f.linker.callChangeCompleted)});return new D(t)};window.$app={configSetting:f.configSetting,configText:f.configText,alert:f.dialog.alert,confirm:f.dialog.confirm,message:f.dialog.message,loading:f.loadingTip.show,loadScript:f.scriptLoader.load,hash:f.linker.hash,baseHash:f.linker.hash,addHash:f.linker.addHash,sameHash:f.linker.sameHash,reload:f.linker.refresh,open:f.open,event:f.event,close:f.viewClose,current:f.current,init:f.init}})();